<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Form - TQRS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        .payment-container {
            max-width: 600px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .payment-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .payment-summary {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .payment-method {
            margin-bottom: 2rem;
        }
        
        .stripe-element {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            background: white;
        }
        
        .payment-options {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .payment-option {
            flex: 1;
            padding: 1rem;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .payment-option.active {
            border-color: #0d6efd;
            background: #f8f9ff;
        }
        
        .payment-option:hover {
            border-color: #0d6efd;
        }
        
        .saved-methods {
            margin-bottom: 1rem;
        }
        
        .saved-method {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            background: white;
        }
        
        .saved-method.active {
            border-color: #0d6efd;
            background: #f8f9ff;
        }
        
        .card-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .card-icon {
            width: 40px;
            height: 25px;
            background: #f8f9fa;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .loading-spinner {
            display: none;
        }
        
        .loading-spinner.show {
            display: inline-block;
        }
        
        .error-message {
            color: #dc3545;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
        
        .success-message {
            color: #198754;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
        
        .donation-amounts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .donation-amount {
            padding: 0.75rem;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .donation-amount.active {
            border-color: #0d6efd;
            background: #0d6efd;
            color: white;
        }
        
        .donation-amount:hover {
            border-color: #0d6efd;
        }
        
        .custom-amount {
            margin-top: 1rem;
        }
        
        .subscription-plans {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .subscription-plan {
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .subscription-plan.active {
            border-color: #0d6efd;
            background: #f8f9ff;
        }
        
        .subscription-plan:hover {
            border-color: #0d6efd;
        }
        
        .plan-price {
            font-size: 2rem;
            font-weight: bold;
            color: #0d6efd;
        }
        
        .plan-period {
            color: #6c757d;
            font-size: 0.875rem;
        }
        
        .plan-features {
            margin-top: 1rem;
            text-align: left;
        }
        
        .plan-features ul {
            list-style: none;
            padding: 0;
        }
        
        .plan-features li {
            padding: 0.25rem 0;
            color: #6c757d;
        }
        
        .plan-features li:before {
            content: "✓";
            color: #198754;
            font-weight: bold;
            margin-right: 0.5rem;
        }
    </style>
</head>
<body class="bg-light">
    <div class="payment-container">
        <!-- Payment Header -->
        <div class="payment-header">
            <h2 id="paymentTitle">Payment</h2>
            <p id="paymentSubtitle">Complete your transaction securely</p>
        </div>

        <!-- Payment Summary -->
        <div class="payment-summary" id="paymentSummary">
            <h5>Payment Summary</h5>
            <div class="row">
                <div class="col-6">
                    <strong>Item:</strong>
                    <span id="itemName">-</span>
                </div>
                <div class="col-6 text-end">
                    <strong>Amount:</strong>
                    <span id="itemAmount">-</span>
                </div>
            </div>
        </div>

        <!-- Payment Type Selection -->
        <div class="payment-options" id="paymentTypeSelector">
            <div class="payment-option active" data-type="card">
                <i class="bi bi-credit-card"></i>
                <div>Credit Card</div>
            </div>
            <div class="payment-option" data-type="saved">
                <i class="bi bi-wallet2"></i>
                <div>Saved Methods</div>
            </div>
        </div>

        <!-- Saved Payment Methods -->
        <div class="saved-methods" id="savedMethods" style="display: none;">
            <h6>Saved Payment Methods</h6>
            <div id="savedMethodsList">
                <!-- Saved methods will be loaded here -->
            </div>
            <button class="btn btn-outline-primary btn-sm" onclick="showNewCardForm()">
                <i class="bi bi-plus"></i> Add New Card
            </button>
        </div>

        <!-- New Card Form -->
        <div class="payment-method" id="newCardForm">
            <h6>Payment Information</h6>
            <div id="card-element" class="stripe-element">
                <!-- Stripe Elements will be inserted here -->
            </div>
            <div id="card-errors" class="error-message"></div>
        </div>

        <!-- Donation Specific Fields -->
        <div id="donationFields" style="display: none;">
            <div class="donation-amounts">
                <div class="donation-amount" data-amount="5">$5</div>
                <div class="donation-amount" data-amount="10">$10</div>
                <div class="donation-amount" data-amount="25">$25</div>
                <div class="donation-amount" data-amount="50">$50</div>
                <div class="donation-amount" data-amount="100">$100</div>
                <div class="donation-amount" data-amount="custom">Custom</div>
            </div>
            
            <div class="custom-amount" id="customAmountField" style="display: none;">
                <label for="customAmount" class="form-label">Custom Amount</label>
                <div class="input-group">
                    <span class="input-group-text">$</span>
                    <input type="number" class="form-control" id="customAmount" min="1" step="0.01" placeholder="Enter amount">
                </div>
            </div>
            
            <div class="mb-3">
                <label for="donorName" class="form-label">Name (Optional)</label>
                <input type="text" class="form-control" id="donorName" placeholder="Your name">
            </div>
            
            <div class="mb-3">
                <label for="donorMessage" class="form-label">Message (Optional)</label>
                <textarea class="form-control" id="donorMessage" rows="3" placeholder="Leave a message"></textarea>
            </div>
            
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="anonymousDonation">
                <label class="form-check-label" for="anonymousDonation">
                    Make this donation anonymous
                </label>
            </div>
        </div>

        <!-- Subscription Plans -->
        <div id="subscriptionPlans" style="display: none;">
            <h6>Choose Your Plan</h6>
            <div class="subscription-plans">
                <div class="subscription-plan" data-plan="monthly" data-price="9.99">
                    <div class="plan-price">$9.99</div>
                    <div class="plan-period">per month</div>
                    <div class="plan-features">
                        <ul>
                            <li>Access to premium webinars</li>
                            <li>Exclusive research content</li>
                            <li>Priority support</li>
                            <li>Early access to new features</li>
                        </ul>
                    </div>
                </div>
                <div class="subscription-plan" data-plan="yearly" data-price="99.99">
                    <div class="plan-price">$99.99</div>
                    <div class="plan-period">per year</div>
                    <div class="plan-features">
                        <ul>
                            <li>All monthly features</li>
                            <li>2 months free</li>
                            <li>Exclusive yearly content</li>
                            <li>VIP webinar access</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="d-grid gap-2">
            <button class="btn btn-primary btn-lg" id="payButton" onclick="processPayment()">
                <span id="payButtonText">Pay Now</span>
                <span class="spinner-border spinner-border-sm loading-spinner" id="paySpinner"></span>
            </button>
            <button class="btn btn-outline-secondary" onclick="cancelPayment()">
                Cancel
            </button>
        </div>

        <!-- Messages -->
        <div id="paymentMessages"></div>
    </div>

    <script>
        // Stripe configuration
        const stripe = Stripe('pk_test_your_publishable_key'); // Replace with your publishable key
        const elements = stripe.elements();
        
        // Payment state
        let paymentType = 'webinar';
        let selectedAmount = 0;
        let selectedPlan = null;
        let paymentMethodId = null;
        let cardElement = null;
        
        // Initialize payment form
        document.addEventListener('DOMContentLoaded', function() {
            initializePaymentForm();
            loadSavedPaymentMethods();
        });
        
        function initializePaymentForm() {
            // Create card element
            cardElement = elements.create('card', {
                style: {
                    base: {
                        fontSize: '16px',
                        color: '#424770',
                        '::placeholder': {
                            color: '#aab7c4',
                        },
                    },
                    invalid: {
                        color: '#9e2146',
                    },
                },
            });
            
            cardElement.mount('#card-element');
            
            // Handle card errors
            cardElement.on('change', function(event) {
                const displayError = document.getElementById('card-errors');
                if (event.error) {
                    displayError.textContent = event.error.message;
                } else {
                    displayError.textContent = '';
                }
            });
            
            // Payment type selection
            document.querySelectorAll('.payment-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.payment-option').forEach(o => o.classList.remove('active'));
                    this.classList.add('active');
                    
                    const type = this.dataset.type;
                    if (type === 'saved') {
                        document.getElementById('savedMethods').style.display = 'block';
                        document.getElementById('newCardForm').style.display = 'none';
                    } else {
                        document.getElementById('savedMethods').style.display = 'none';
                        document.getElementById('newCardForm').style.display = 'block';
                    }
                });
            });
            
            // Donation amount selection
            document.querySelectorAll('.donation-amount').forEach(amount => {
                amount.addEventListener('click', function() {
                    document.querySelectorAll('.donation-amount').forEach(a => a.classList.remove('active'));
                    this.classList.add('active');
                    
                    const amountValue = this.dataset.amount;
                    if (amountValue === 'custom') {
                        document.getElementById('customAmountField').style.display = 'block';
                        document.getElementById('customAmount').focus();
                    } else {
                        document.getElementById('customAmountField').style.display = 'none';
                        selectedAmount = parseFloat(amountValue);
                        updatePaymentSummary();
                    }
                });
            });
            
            // Custom amount input
            document.getElementById('customAmount').addEventListener('input', function() {
                selectedAmount = parseFloat(this.value) || 0;
                updatePaymentSummary();
            });
            
            // Subscription plan selection
            document.querySelectorAll('.subscription-plan').forEach(plan => {
                plan.addEventListener('click', function() {
                    document.querySelectorAll('.subscription-plan').forEach(p => p.classList.remove('active'));
                    this.classList.add('active');
                    
                    selectedPlan = this.dataset.plan;
                    selectedAmount = parseFloat(this.dataset.price);
                    updatePaymentSummary();
                });
            });
        }
        
        function loadSavedPaymentMethods() {
            const token = localStorage.getItem('access_token');
            if (!token) return;
            
            fetch('/api/payments/methods', {
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.data.length > 0) {
                    displaySavedMethods(data.data);
                }
            })
            .catch(error => {
                console.error('Error loading saved methods:', error);
            });
        }
        
        function displaySavedMethods(methods) {
            const container = document.getElementById('savedMethodsList');
            container.innerHTML = methods.map(method => `
                <div class="saved-method" data-method-id="${method.id}">
                    <div class="card-info">
                        <div class="card-icon">${method.card.brand.toUpperCase()}</div>
                        <div>
                            <div>•••• •••• •••• ${method.card.last4}</div>
                            <small class="text-muted">Expires ${method.card.exp_month}/${method.card.exp_year}</small>
                        </div>
                    </div>
                    <button class="btn btn-sm btn-outline-danger" onclick="removePaymentMethod('${method.id}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `).join('');
            
            // Add click handlers
            document.querySelectorAll('.saved-method').forEach(method => {
                method.addEventListener('click', function(e) {
                    if (e.target.closest('.btn-outline-danger')) return;
                    
                    document.querySelectorAll('.saved-method').forEach(m => m.classList.remove('active'));
                    this.classList.add('active');
                    paymentMethodId = this.dataset.methodId;
                });
            });
        }
        
        function showNewCardForm() {
            document.getElementById('savedMethods').style.display = 'none';
            document.getElementById('newCardForm').style.display = 'block';
            document.querySelector('.payment-option[data-type="card"]').click();
        }
        
        function setPaymentType(type, data = {}) {
            paymentType = type;
            
            // Update UI based on payment type
            document.getElementById('donationFields').style.display = type === 'donation' ? 'block' : 'none';
            document.getElementById('subscriptionPlans').style.display = type === 'subscription' ? 'block' : 'none';
            
            // Update payment summary
            if (type === 'webinar') {
                document.getElementById('paymentTitle').textContent = 'Webinar Registration';
                document.getElementById('paymentSubtitle').textContent = 'Complete your webinar registration';
                document.getElementById('itemName').textContent = data.title || 'Webinar Registration';
                document.getElementById('itemAmount').textContent = `$${data.amount || 0}`;
                selectedAmount = data.amount || 0;
            } else if (type === 'donation') {
                document.getElementById('paymentTitle').textContent = 'Make a Donation';
                document.getElementById('paymentSubtitle').textContent = 'Support TQRS research initiatives';
                document.getElementById('itemName').textContent = 'Donation to TQRS';
                document.getElementById('itemAmount').textContent = '$0';
                selectedAmount = 0;
            } else if (type === 'subscription') {
                document.getElementById('paymentTitle').textContent = 'Premium Subscription';
                document.getElementById('paymentSubtitle').textContent = 'Choose your subscription plan';
                document.getElementById('itemName').textContent = 'Premium Subscription';
                document.getElementById('itemAmount').textContent = '$0';
                selectedAmount = 0;
            }
        }
        
        function updatePaymentSummary() {
            if (selectedAmount > 0) {
                document.getElementById('itemAmount').textContent = `$${selectedAmount.toFixed(2)}`;
            }
        }
        
        async function processPayment() {
            const button = document.getElementById('payButton');
            const buttonText = document.getElementById('payButtonText');
            const spinner = document.getElementById('paySpinner');
            
            // Show loading state
            button.disabled = true;
            buttonText.style.display = 'none';
            spinner.classList.add('show');
            
            try {
                let paymentData = {
                    amount: selectedAmount,
                    currency: 'usd'
                };
                
                if (paymentType === 'webinar') {
                    paymentData.webinar_id = getUrlParameter('webinar_id');
                    paymentData.payment_method_id = await getPaymentMethodId();
                    
                    const response = await fetch('/api/payments/webinar', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + localStorage.getItem('access_token'),
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(paymentData)
                    });
                    
                    await handlePaymentResponse(response);
                    
                } else if (paymentType === 'donation') {
                    paymentData.payment_method_id = await getPaymentMethodId();
                    paymentData.donor_name = document.getElementById('donorName').value;
                    paymentData.donor_email = localStorage.getItem('user_email');
                    paymentData.message = document.getElementById('donorMessage').value;
                    paymentData.anonymous = document.getElementById('anonymousDonation').checked;
                    
                    const response = await fetch('/api/payments/donation', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + localStorage.getItem('access_token'),
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(paymentData)
                    });
                    
                    await handlePaymentResponse(response);
                    
                } else if (paymentType === 'subscription') {
                    paymentData.plan_id = getStripePlanId(selectedPlan);
                    paymentData.payment_method_id = await getPaymentMethodId();
                    paymentData.plan_type = selectedPlan;
                    
                    const response = await fetch('/api/payments/subscription', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + localStorage.getItem('access_token'),
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(paymentData)
                    });
                    
                    await handlePaymentResponse(response);
                }
                
            } catch (error) {
                console.error('Payment error:', error);
                showMessage('Payment failed. Please try again.', 'error');
            } finally {
                // Reset button state
                button.disabled = false;
                buttonText.style.display = 'inline';
                spinner.classList.remove('show');
            }
        }
        
        async function getPaymentMethodId() {
            if (paymentMethodId) {
                return paymentMethodId;
            }
            
            // Create payment method from card element
            const { paymentMethod, error } = await stripe.createPaymentMethod({
                type: 'card',
                card: cardElement,
            });
            
            if (error) {
                throw new Error(error.message);
            }
            
            return paymentMethod.id;
        }
        
        async function handlePaymentResponse(response) {
            const data = await response.json();
            
            if (data.success) {
                if (data.payment_intent && data.payment_intent.status === 'requires_action') {
                    // Handle 3D Secure authentication
                    const { error } = await stripe.confirmCardPayment(data.payment_intent.client_secret);
                    
                    if (error) {
                        throw new Error(error.message);
                    }
                }
                
                // Confirm payment
                await fetch('/api/payments/confirm', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('access_token'),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        payment_intent_id: data.payment_intent.id
                    })
                });
                
                showMessage('Payment completed successfully!', 'success');
                setTimeout(() => {
                    window.location.href = '/dashboard';
                }, 2000);
                
            } else {
                throw new Error(data.message || 'Payment failed');
            }
        }
        
        function getStripePlanId(planType) {
            const plans = {
                'monthly': 'price_monthly_plan_id', // Replace with actual Stripe price ID
                'yearly': 'price_yearly_plan_id'   // Replace with actual Stripe price ID
            };
            return plans[planType];
        }
        
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }
        
        function showMessage(message, type) {
            const container = document.getElementById('paymentMessages');
            const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            
            container.innerHTML = `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }
        
        function cancelPayment() {
            window.history.back();
        }
        
        function removePaymentMethod(methodId) {
            if (!confirm('Are you sure you want to remove this payment method?')) {
                return;
            }
            
            fetch(`/api/payments/methods/${methodId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('access_token'),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadSavedPaymentMethods();
                    showMessage('Payment method removed successfully', 'success');
                } else {
                    showMessage('Failed to remove payment method', 'error');
                }
            })
            .catch(error => {
                console.error('Error removing payment method:', error);
                showMessage('Failed to remove payment method', 'error');
            });
        }
        
        // Initialize payment type based on URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const type = urlParams.get('type');
        
        if (type === 'donation') {
            setPaymentType('donation');
        } else if (type === 'subscription') {
            setPaymentType('subscription');
        } else {
            // Default to webinar payment
            const webinarId = urlParams.get('webinar_id');
            const webinarTitle = urlParams.get('title');
            const webinarAmount = urlParams.get('amount');
            
            setPaymentType('webinar', {
                id: webinarId,
                title: webinarTitle,
                amount: parseFloat(webinarAmount) || 0
            });
        }
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html> 